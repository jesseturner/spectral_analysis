# Plotting the training and testing lat-lon points on the ABI image. 

import matplotlib.pyplot as plt
import cartopy.crs as ccrs
import numpy as np
import pandas as pd
from modules_cris import cris_utils as c_utils

#--- Grab GOES utils from outside path
import sys
sys.path.append("../GOES_Analysis")
from GOES_utils import goes_utils as g_utils

#--- Training set

training_df = pd.DataFrame(
    [
        (45.0, -72.5, "mixed"), 
        (45.0, -72.0, "mixed"), 
        (45.0, -71.5, "mixed"), 
        (45.0, -71.0, "mixed"), 
        (45.0, -70.5, "mixed"), 
        (45.0, -70.0, "mixed"), 
        (45.0, -69.5, "mixed"), 
        (45.0, -69.0, "mixed"), 
        (45.0, -68.5, "mixed"), 
        (45.0, -68.0, "mixed"), 
        (45.0, -67.5, "TLC"), 
        (45.0, -67.0, "TLC"), 
        (45.0, -66.5, "TLC"), 
        (45.0, -66.0, "mixed"), 
        (45.0, -65.5, "HC"), 
        (45.0, -65.0, "mixed"), 
        (45.0, -64.5, "TLC"),
        (45.0, -64.0, "TLC"),
        (45.0, -63.5, "TLC"),
        (45.0, -63.0, "TLC"),
        (45.0, -62.5, "TLC"),
        (45.0, -62.0, "TLC"),
        (45.0, -61.5, "mixed"),
        (45.0, -61.0, "clear"),
        (45.0, -60.5, "mixed"),
        (45.0, -60.0, "mixed"),
        (45.0, -59.5, "clear"),
        (45.0, -59.0, "clear"),
        (45.0, -58.5, "clear"),
        (45.0, -58.0, "clear"),
        (45.0, -57.5, "clear"),

        (44.5, -72.5, "mixed"), 
        (44.5, -72.0, "mixed"), 
        (44.5, -71.5, "mixed"), 
        (44.5, -71.0, "mixed"), 
        (44.5, -70.5, "mixed"), 
        (44.5, -70.0, "mixed"), 
        (44.5, -69.5, "HC"), 
        (44.5, -69.0, "mixed"), 
        (44.5, -68.5, "mixed"), 
        (44.5, -68.0, "mixed"), 
        (44.5, -67.5, "mixed"), 
        (44.5, -67.0, "mixed"), 
        (44.5, -66.5, "HC"), 
        (44.5, -66.0, "mixed"), 
        (44.5, -65.5, "TLC"), 
        (44.5, -65.0, "TLC"), 
        (44.5, -64.5, "TLC"),
        (44.5, -64.0, "TLC"),
        (44.5, -63.5, "TLC"),
        (44.5, -63.0, "TLC"),
        (44.5, -62.5, "TLC"),
        (44.5, -62.0, "TLC"),
        (44.5, -61.5, "clear"),
        (44.5, -61.0, "clear"),
        (44.5, -60.5, "clear"),
        (44.5, -60.0, "clear"),
        (44.5, -59.5, "clear"),
        (44.5, -59.0, "clear"),
        (44.5, -58.5, "clear"),
        (44.5, -58.0, "clear"),
        (44.5, -57.5, "clear"),

        (44.0, -72.5, "mixed"), 
        (44.0, -72.0, "mixed"), 
        (44.0, -71.5, "mixed"), 
        (44.0, -71.0, "mixed"), 
        (44.0, -70.5, "mixed"), 
        (44.0, -70.0, "mixed"), 
        (44.0, -69.5, "mixed"), 
        (44.0, -69.0, "mixed"), 
        (44.0, -68.5, "mixed"), 
        (44.0, -68.0, "mixed"), 
        (44.0, -67.5, "mixed"), 
        (44.0, -67.0, "HC"), 
        (44.0, -66.5, "HC"), 
        (44.0, -66.0, "TLC"), 
        (44.0, -65.5, "TLC"), 
        (44.0, -65.0, "TLC"), 
        (44.0, -64.5, "TLC"), 
        (44.0, -64.0, "TLC"),
        (44.0, -63.5, "TLC"), 
        (44.0, -63.0, "TLC"),  
        (44.0, -62.5, "TLC"), 
        (44.0, -62.0, "mixed"),
        (44.0, -61.5, "clear"),
        (44.0, -61.0, "clear"),
        (44.0, -60.5, "clear"),
        (44.0, -60.0, "clear"),
        (44.0, -59.5, "clear"),
        (44.0, -59.0, "clear"),
        (44.0, -58.5, "clear"),
        (44.0, -58.0, "clear"),
        (44.0, -57.5, "clear"),
    
        (43.5, -72.5, "mixed"), 
        (43.5, -72.0, "mixed"), 
        (43.5, -71.5, "mixed"), 
        (43.5, -71.0, "mixed"), 
        (43.5, -70.5, "mixed"), 
        (43.5, -70.0, "mixed"), 
        (43.5, -69.5, "mixed"), 
        (43.5, -69.0, "mixed"), 
        (43.5, -68.5, "mixed"), 
        (43.5, -68.0, "mixed"), 
        (43.5, -67.5, "mixed"), 
        (43.5, -67.0, "mixed"), 
        (43.5, -66.5, "mixed"), 
        (43.5, -66.0, "FLC"), 
        (43.5, -65.5, "TLC"), 
        (43.5, -65.0, "TLC"), 
        (43.5, -64.5, "TLC"), 
        (43.5, -64.0, "TLC"), 
        (43.5, -63.5, "TLC"), 
        (43.5, -63.0, "TLC"),
        (43.5, -62.5, "TLC"),
        (43.5, -62.0, "clear"),
        (43.5, -61.5, "clear"),
        (43.5, -61.0, "clear"),
        (43.5, -60.5, "clear"),
        (43.5, -60.0, "clear"),
        (43.5, -59.5, "clear"),
        (43.5, -59.0, "clear"),
        (43.5, -58.5, "clear"),
        (43.5, -58.0, "clear"),
        (43.5, -57.5, "clear"),

        (43.0, -72.5, "mixed"), 
        (43.0, -72.0, "mixed"), 
        (43.0, -71.5, "mixed"), 
        (43.0, -71.0, "mixed"), 
        (43.0, -70.5, "mixed"), 
        (43.0, -70.0, "mixed"), 
        (43.0, -69.5, "mixed"), 
        (43.0, -69.0, "mixed"), 
        (43.0, -68.5, "mixed"), 
        (43.0, -68.0, "mixed"), 
        (43.0, -67.5, "FLC"), 
        (43.0, -67.0, "FLC"), 
        (43.0, -66.5, "FLC"), 
        (43.0, -66.0, "FLC"),
        (43.0, -65.5, "TLC"), 
        (43.0, -65.0, "TLC"), 
        (43.0, -64.5, "TLC"), 
        (43.0, -64.0, "TLC"), 
        (43.0, -63.5, "TLC"), 
        (43.0, -63.0, "TLC"), 
        (43.0, -62.5, "clear"),
        (43.0, -62.0, "clear"),
        (43.0, -61.5, "clear"),
        (43.0, -61.0, "clear"),
        (43.0, -60.5, "clear"),
        (43.0, -60.0, "clear"),
        (43.0, -59.5, "mixed"),
        (43.0, -59.0, "mixed"),
        (43.0, -58.5, "mixed"),
        (43.0, -58.0, "mixed"),
        (43.0, -57.5, "mixed"),

        (42.5, -72.5, "clear"), 
        (42.5, -72.0, "clear"), 
        (42.5, -71.5, "clear"), 
        (42.5, -71.0, "clear"), 
        (42.5, -70.5, "clear"), 
        (42.5, -70.0, "clear"), 
        (42.5, -69.5, "clear"), 
        (42.5, -69.0, "clear"), 
        (42.5, -68.5, "FLC"), 
        (42.5, -68.0, "FLC"), 
        (42.5, -67.5, "FLC"), 
        (42.5, -67.0, "FLC"), 
        (42.5, -66.5, "FLC"), 
        (42.5, -66.0, "mixed"), 
        (42.5, -65.5, "TLC"), 
        (42.5, -65.0, "TLC"), 
        (42.5, -64.5, "TLC"), 
        (42.5, -64.0, "TLC"), 
        (42.5, -63.5, "mixed"),
        (42.5, -63.0, "clear"),
        (42.5, -62.5, "clear"),
        (42.5, -62.0, "clear"),
        (42.5, -61.5, "clear"),
        (42.5, -61.0, "clear"),
        (42.5, -60.5, "HC"),
        (42.5, -60.0, "HC"),
        (42.5, -59.5, "HC"),
        (42.5, -59.0, "HC"),
        (42.5, -58.5, "HC"),
        (42.5, -58.0, "HC"),
        (42.5, -57.5, "HC"),

        (42.0, -72.5, "clear"), 
        (42.0, -72.0, "clear"), 
        (42.0, -71.5, "clear"), 
        (42.0, -71.0, "clear"), 
        (42.0, -70.5, "clear"), 
        (42.0, -70.0, "clear"), 
        (42.0, -69.5, "clear"), 
        (42.0, -69.0, "FLC"), 
        (42.0, -68.5, "FLC"), 
        (42.0, -68.0, "FLC"), 
        (42.0, -67.5, "FLC"), 
        (42.0, -67.0, "mixed"), 
        (42.0, -66.5, "mixed"), 
        (42.0, -66.0, "TLC"), 
        (42.0, -65.5, "TLC"), 
        (42.0, -65.0, "TLC"), 
        (42.0, -64.5, "mixed"),
        (42.0, -64.0, "mixed"),
        (42.0, -63.5, "mixed"),
        (42.0, -63.0, "mixed"),
        (42.0, -62.5, "mixed"),
        (42.0, -62.0, "mixed"),
        (42.0, -61.5, "HC"),
        (42.0, -61.0, "HC"),
        (42.0, -60.5, "HC"),
        (42.0, -60.0, "HC"),
        (42.0, -59.5, "HC"),
        (42.0, -59.0, "HC"),
        (42.0, -58.5, "HC"),
        (42.0, -58.0, "HC"),
        (42.0, -57.5, ""),

        (41.5, -72.5, "clear"), 
        (41.5, -72.0, "clear"), 
        (41.5, -71.5, "clear"), 
        (41.5, -71.0, "clear"), 
        (41.5, -70.5, "clear"), 
        (41.5, -70.0, "clear"), 
        (41.5, -69.5, "clear"), 
        (41.5, -69.0, "FLC"), 
        (41.5, -68.5, "FLC"), 
        (41.5, -68.0, "FLC"), 
        (41.5, -67.5, "mixed"), 
        (41.5, -67.0, "TLC"), 
        (41.5, -66.5, "TLC"), 
        (41.5, -66.0, "TLC"), 
        (41.5, -65.5, "TLC"), 
        (41.5, -65.0, "FLC"), 
        (41.5, -64.5, "FLC"),
        (41.5, -64.0, "mixed"),
        (41.5, -63.5, "mixed"),
        (41.5, -63.0, "mixed"),
        (41.5, -62.5, "HC"),
        (41.5, -62.0, "HC"),
        (41.5, -61.5, "HC"),
        (41.5, -61.0, "HC"),
        (41.5, -60.5, "HC"),
        (41.5, -60.0, "HC"),
        (41.5, -59.5, "HC"),
        (41.5, -59.0, "HC"),
        (41.5, -58.5, "HC"),
        (41.5, -58.0, ""),
        (41.5, -57.5, ""),

        (41.0, -72.5, "clear"), 
        (41.0, -72.0, "clear"), 
        (41.0, -71.5, "clear"), 
        (41.0, -71.0, "clear"), 
        (41.0, -70.5, "clear"), 
        (41.0, -70.0, "clear"), 
        (41.0, -69.5, "FLC"), 
        (41.0, -69.0, "FLC"), 
        (41.0, -68.5, "FLC"), 
        (41.0, -68.0, "mixed"), 
        (41.0, -67.5, "mixed"), 
        (41.0, -67.0, "mixed"), 
        (41.0, -66.5, "mixed"), 
        (41.0, -66.0, "mixed"), 
        (41.0, -65.5, "FLC"), 
        (41.0, -65.0, "FLC"), 
        (41.0, -64.5, "FLC"),
        (41.0, -64.0, "mixed"),
        (41.0, -63.5, "HC"),
        (41.0, -63.0, "HC"),
        (41.0, -62.5, "HC"),
        (41.0, -62.0, "HC"),
        (41.0, -61.5, "HC"),
        (41.0, -61.0, "HC"),
        (41.0, -60.5, "HC"),
        (41.0, -60.0, "HC"),
        (41.0, -59.5, "HC"),
        (41.0, -59.0, "HC"),
        (41.0, -58.5, "HC"),
        (41.0, -58.0, ""),
        (41.0, -57.5, ""),

        (40.5, -72.5, "clear"), 
        (40.5, -72.0, "clear"), 
        (40.5, -71.5, "clear"), 
        (40.5, -71.0, "clear"), 
        (40.5, -70.5, "clear"), 
        (40.5, -70.0, "FLC"), 
        (40.5, -69.5, "FLC"), 
        (40.5, -69.0, "FLC"), 
        (40.5, -68.5, "FLC"), 
        (40.5, -68.0, "mixed"), 
        (40.5, -67.5, "mixed"), 
        (40.5, -67.0, "mixed"), 
        (40.5, -66.5, "mixed"), 
        (40.5, -66.0, "mixed"), 
        (40.5, -65.5, "mixed"), 
        (40.5, -65.0, "mixed"), 
        (40.5, -64.5, "mixed"),
        (40.5, -64.0, "HC"),
        (40.5, -63.5, "HC"),
        (40.5, -63.0, "HC"),
        (40.5, -62.5, "HC"),
        (40.5, -62.0, "HC"),
        (40.5, -61.5, "HC"),
        (40.5, -61.0, "HC"),
        (40.5, -60.5, "HC"),
        (40.5, -60.0, "HC"),
        (40.5, -59.5, "HC"),
        (40.5, -59.0, "HC"),
        (40.5, -58.5, ""),
        (40.5, -58.0, ""),
        (40.5, -57.5, ""),

        (40.0, -72.5, "clear"), 
        (40.0, -72.0, "clear"), 
        (40.0, -71.5, "clear"), 
        (40.0, -71.0, "clear"), 
        (40.0, -70.5, "FLC"), 
        (40.0, -70.0, "FLC"), 
        (40.0, -69.5, "FLC"), 
        (40.0, -69.0, "FLC"), 
        (40.0, -68.5, "FLC"),
        (40.0, -68.0, "mixed"), 
        (40.0, -67.5, "mixed"), 
        (40.0, -67.0, "mixed"), 
        (40.0, -66.5, "mixed"), 
        (40.0, -66.0, "mixed"), 
        (40.0, -65.5, "mixed"), 
        (40.0, -65.0, "mixed"), 
        (40.0, -64.5, "mixed"),
        (40.0, -64.0, "HC"),
        (40.0, -63.5, "HC"),
        (40.0, -63.0, "HC"),
        (40.0, -62.5, "HC"),
        (40.0, -62.0, "HC"),
        (40.0, -61.5, "HC"),
        (40.0, -61.0, "HC"),
        (40.0, -60.5, "HC"),
        (40.0, -60.0, "HC"),
        (40.0, -59.5, "HC"),
        (40.0, -59.0, "HC"),
        (40.0, -58.5, ""),
        (40.0, -58.0, ""),
        (40.0, -57.5, ""),

        (39.5, -72.5, "clear"), 
        (39.5, -72.0, "clear"), 
        (39.5, -71.5, "clear"), 
        (39.5, -71.0, "FLC"), 
        (39.5, -70.5, "FLC"), 
        (39.5, -70.0, "FLC"),  
        (39.5, -69.5, "FLC"), 
        (39.5, -69.0, "FLC"), 
        (39.5, -68.5, "FLC"), 
        (39.5, -68.0, "FLC"),
        (39.5, -67.5, "mixed"), 
        (39.5, -67.0, "mixed"), 
        (39.5, -66.5, "mixed"), 
        (39.5, -66.0, "mixed"), 
        (39.5, -65.5, "HC"), 
        (39.5, -65.0, "HC"), 
        (39.5, -64.5, "HC"),
        (39.5, -64.0, "HC"),
        (39.5, -63.5, "HC"),
        (39.5, -63.0, "HC"),
        (39.5, -62.5, "HC"),
        (39.5, -62.0, "HC"),
        (39.5, -61.5, "HC"),
        (39.5, -61.0, "HC"),
        (39.5, -60.5, "HC"),
        (39.5, -60.0, "HC"),
        (39.5, -59.5, "HC"),
        (39.5, -59.0, ""),
        (39.5, -58.5, ""),
        (39.5, -58.0, ""),
        (39.5, -57.5, ""),

        (39.0, -72.5, "clear"), 
        (39.0, -72.0, "clear"), 
        (39.0, -71.5, "clear"), 
        (39.0, -71.0, "FLC"), 
        (39.0, -70.5, "FLC"), 
        (39.0, -71.0, "FLC"), 
        (39.0, -70.5, "FLC"), 
        (39.0, -70.0, "FLC"),  
        (39.0, -69.5, "FLC"), 
        (39.0, -69.0, "FLC"), 
        (39.0, -68.5, "FLC"), 
        (39.0, -68.0, "FLC"), 
        (39.0, -67.5, "FLC"), 
        (39.0, -67.0, "mixed"), 
        (39.0, -66.5, "mixed"), 
        (39.0, -66.0, "mixed"), 
        (39.0, -65.5, "HC"), 
        (39.0, -65.0, "HC"), 
        (39.0, -64.5, "HC"),
        (39.0, -64.0, "HC"),
        (39.0, -63.5, "HC"),
        (39.0, -63.0, "HC"),
        (39.0, -62.5, "HC"),
        (39.0, -62.0, "HC"),
        (39.0, -61.5, "HC"),
        (39.0, -61.0, "HC"),
        (39.0, -60.5, "HC"),
        (39.0, -60.0, "HC"),
        (39.0, -59.5, "HC"),
        (39.0, -59.0, ""),
        (39.0, -58.5, ""),
        (39.0, -58.0, ""),
        (39.0, -57.5, ""),

        (38.5, -72.5, "clear"), 
        (38.5, -72.0, "clear"), 
        (38.5, -71.5, "FLC"), 
        (38.5, -71.0, "FLC"), 
        (38.5, -70.5, "FLC"), 
        (38.5, -70.0, "FLC"), 
        (38.5, -69.5, "HC"), 
        (38.5, -69.0, "HC"), 
        (38.5, -68.5, "HC"), 
        (38.5, -68.0, "FLC"), 
        (38.5, -67.5, "FLC"), 
        (38.5, -67.0, "FLC"), 
        (38.5, -66.5, "HC"), 
        (38.5, -66.0, "HC"), 
        (38.5, -65.5, "HC"), 
        (38.5, -65.0, "HC"), 
        (38.5, -64.5, "HC"),
        (38.5, -64.0, "HC"),
        (38.5, -63.5, "HC"),
        (38.5, -63.0, "HC"),
        (38.5, -62.5, "HC"),
        (38.5, -62.0, "HC"),
        (38.5, -61.5, "HC"),
        (38.5, -61.0, "HC"),
        (38.5, -60.5, "HC"),
        (38.5, -60.0, "HC"),
        (38.5, -59.5, ""),
        (38.5, -59.0, ""),
        (38.5, -58.5, ""),
        (38.5, -58.0, ""),
        (38.5, -57.5, ""),

        (38.0, -72.5, "FLC"), 
        (38.0, -72.0, "FLC"), 
        (38.0, -71.5, "FLC"), 
        (38.0, -71.0, "FLC"), 
        (38.0, -70.5, "HC"), 
        (38.0, -70.0, "HC"), 
        (38.0, -69.5, "HC"), 
        (38.0, -69.0, "HC"), 
        (38.0, -68.5, "HC"), 
        (38.0, -68.0, "HC"), 
        (38.0, -67.5, "HC"), 
        (38.0, -67.0, "FLC"), 
        (38.0, -66.5, "HC"), 
        (38.0, -66.0, "HC"), 
        (38.0, -65.5, "HC"), 
        (38.0, -65.0, "HC"), 
        (38.0, -64.5, "HC"),
        (38.0, -64.0, "HC"),
        (38.0, -63.5, "HC"),
        (38.0, -63.0, "HC"),
        (38.0, -62.5, "HC"),
        (38.0, -62.0, "HC"),
        (38.0, -61.5, "HC"),
        (38.0, -61.0, "HC"),
        (38.0, -60.5, "HC"),
        (38.0, -60.0, "HC"),
        (38.0, -59.5, ""),
        (38.0, -59.0, ""),
        (38.0, -58.5, ""),
        (38.0, -58.0, ""),
        (38.0, -57.5, ""),



    ],
    columns=["lat", "lon", "label"]
)

year = 2025
month = 3
day = 12
hour = 6
ten_minutes = 4
band1, wl1 = '13', 10.3
band2, wl2 = '07', 3.9
sat = 'goes19'
extent=[-73, -57, 33, 46]
g_utils.set_plots_dark() # all following plots will use dark setting

#--- Open GOES ABI data
ds1 = g_utils.get_goes_data(band1, sat, year, month, day, hour, ten_minutes)
ds1 = g_utils.get_region_by_lat_lon(ds1, extent)

ds2 = g_utils.get_goes_data(band2, sat, year, month, day, hour, ten_minutes)
ds2 = g_utils.get_region_by_lat_lon(ds2, extent)

fig_name = f"{sat}_{band1}-{band2}_{year}{month:02}{day:02}_{hour:02}{ten_minutes}0"
plot_title = f"ABI B{band1} - B{band2} ({wl1} µm - {wl2} µm) BTD \n {sat} d{year}{month:02}{day:02} t{hour:02}{ten_minutes}0"

wl1 = round(ds1.band_wavelength.values[0],1)
Tb1 = (ds1.planck_fk2/(np.log((ds1.planck_fk1/ds1.Rad)+1)) - ds1.planck_bc1)/ds1.planck_bc2
wl2 = round(ds2.band_wavelength.values[0],1)
Tb2 = (ds2.planck_fk2/(np.log((ds2.planck_fk1/ds2.Rad)+1)) - ds2.planck_bc1)/ds2.planck_bc2
btd = Tb1 - Tb2

projection = ccrs.PlateCarree()
fig, ax = plt.subplots(figsize=(12, 12), subplot_kw={"projection": projection})

#--- Plot ABI
custom_cmap_name = "blueblack"
cmap, norm = g_utils.custom_cmap_selection(custom_cmap_name)
pcm = plt.pcolormesh(btd.lon, btd.lat, btd, cmap=cmap, norm=norm, shading="nearest")

#--- Plot CrIS
file_path = "data/cris/SNDR.J1.CRIS.20250312T0642.m06.g068.L1B.std.v03_08.G.250312132403.nc"
ds_spatial = c_utils.open_cris_data(file_path)
ds_t_11, ds_11 = c_utils.get_cris_band_Tb(ds_spatial, 
    srf_file="data/spectral_response_functions/NPP_VIIRS_NG_RSR_I5_filtered_Oct2011f_BA.dat")
ds_t_3_9, ds_3_9 = c_utils.get_cris_band_Tb(ds_spatial, 
    srf_file="data/spectral_response_functions/GOES-R_ABI_SRF_ch7.dat")
ds_btd = ds_t_11 - ds_t_3_9
print(ds_btd)
cris_spatial = plt.pcolormesh(ds_3_9['lon'], ds_3_9['lat'], ds_btd, 
                              cmap=cmap, norm=norm, shading="nearest", alpha=0.5)

label_styles = {
    "FLC": dict(color="cyan", marker="o", label="False Low Cloud"),
    "clear": dict(color="black", marker="o", label="Clear Sky"),
    "TLC": dict(color="magenta", marker="^", label="True Low Cloud"),
    "HC": dict(color="white", marker="^", label="High Cloud"),
    "mixed": dict(color="white", marker="x", label="Mixed Pixel"),
}

for label, style in label_styles.items():
    d = training_df[training_df["label"] == label]

    ax.scatter(
        d["lon"],
        d["lat"],
        s=60,
        edgecolors="white",
        linewidths=0.7,
        transform=ccrs.PlateCarree(),
        zorder=4,
        **style,
    )

clb = plt.colorbar(pcm, shrink=0.6, pad=0.02, ax=ax)
clb.set_label("(K)", fontsize=15)
clb.ax.tick_params(labelsize=15)

ax.set_extent(extent, crs=ccrs.PlateCarree())
ax.set_title(plot_title, fontsize=20, pad=10)
ax.coastlines(resolution="50m", color="white", linewidth=2)

ax.legend(
    loc="lower left",
    fontsize=12,
    frameon=True,
    facecolor="black",
    edgecolor="white",
)

plt.savefig(f"plots/fig2_training_set.png", dpi=200, bbox_inches='tight')
plt.close()